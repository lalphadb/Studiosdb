@extends('layouts.admin')

@section('title', 'Nouveau Membre - Wizard')

@push('styles')
<link rel="stylesheet" href="{{ asset('css/studiosdb-glassmorphic.css') }}">
@endpush

@section('content')
<div class="wizard-container">
    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="wizard-step active" data-step="1">
            <div class="wizard-step-circle">
                <i class="fas fa-user"></i>
            </div>
            <span class="text-white text-sm">Informations</span>
        </div>
        
        <div class="wizard-step" data-step="2">
            <div class="wizard-step-circle">
                <i class="fas fa-phone"></i>
            </div>
            <span class="text-white text-sm">Contact</span>
        </div>
        
        <div class="wizard-step" data-step="3">
            <div class="wizard-step-circle">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <span class="text-white text-sm">Karaté</span>
        </div>
        
        <div class="wizard-step" data-step="4">
            <div class="wizard-step-circle">
                <i class="fas fa-check"></i>
            </div>
            <span class="text-white text-sm">Confirmation</span>
        </div>
    </div>

    <!-- Form Container -->
    <form id="wizardForm" method="POST" action="{{ route('admin.membres.store') }}" enctype="multipart/form-data">
        @csrf
        
        <!-- École cachée pour admin -->
        @if(auth()->user()->role === 'admin')
            <input type="hidden" name="ecole_id" value="{{ auth()->user()->ecole_id }}">
        @endif

        <!-- Step 1: Informations personnelles -->
        <div class="wizard-step-content active" data-step="1">
            <div class="glass-card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center">
                    <i class="fas fa-user-ninja mr-3 text-neon-blue"></i>
                    Informations personnelles
                </h2>

                <!-- Avatar Upload -->
                <div class="avatar-upload">
                    <div class="avatar-preview" onclick="document.getElementById('photo').click()">
                        <img id="avatarPreview" style="display: none;">
                        <i class="fas fa-camera text-4xl text-gray-400" id="cameraIcon"></i>
                    </div>
                    <div class="avatar-upload-btn" onclick="document.getElementById('photo').click()">
                        <i class="fas fa-plus"></i>
                    </div>
                    <input type="file" id="photo" name="photo" accept="image" style="display: none;" onchange="previewAvatar(event)">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-floating">
                        <input type="text" 
                               id="prenom" 
                               name="prenom" 
                               class="glass-input" 
                               placeholder="Prénom"
                               value="{{ old('prenom') }}"
                               required>
                        <label for="prenom">Prénom *</label>
                    </div>

                    <div class="form-floating">
                        <input type="text" 
                               id="nom" 
                               name="nom" 
                               class="glass-input" 
                               placeholder="Nom"
                               value="{{ old('nom') }}"
                               required>
                        <label for="nom">Nom *</label>
                    </div>

                    <div class="form-floating">
                        <input type="date" 
                               id="date_naissance" 
                               name="date_naissance" 
                               class="glass-input"
                               value="{{ old('date_naissance') }}"
                               onchange="calculateAge()">
                        <label for="date_naissance">Date de naissance</label>
                    </div>

                    <div class="form-floating">
                        <select id="sexe" name="sexe" class="glass-input">
                            <option value="">Non spécifié</option>
                            <option value="H" {{ old('sexe') == 'H' ? 'selected' : '' }}>Homme</option>
                            <option value="F" {{ old('sexe') == 'F' ? 'selected' : '' }}>Femme</option>
                        </select>
                        <label for="sexe">Genre</label>
                    </div>
                </div>

                <!-- Age Display -->
                <div id="ageDisplay" class="mt-4 text-center text-gray-400" style="display: none;">
                    <i class="fas fa-birthday-cake mr-2"></i>
                    <span id="ageText"></span>
                </div>
            </div>
        </div>

        <!-- Step 2: Contact -->
        <div class="wizard-step-content" data-step="2" style="display: none;">
            <div class="glass-card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center">
                    <i class="fas fa-address-book mr-3 text-neon-purple"></i>
                    Informations de contact
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-floating">
                        <input type="email" 
                               id="email" 
                               name="email" 
                               class="glass-input"
                               placeholder="Email"
                               value="{{ old('email') }}">
                        <label for="email">Adresse email</label>
                    </div>

                    <div class="form-floating">
                        <input type="tel" 
                               id="telephone" 
                               name="telephone" 
                               class="glass-input"
                               placeholder="Téléphone"
                               value="{{ old('telephone') }}">
                        <label for="telephone">Téléphone</label>
                    </div>
                </div>

                <!-- École (seulement pour superadmin) -->
                @if(auth()->user()->role === 'superadmin')
                <div class="form-floating mt-6">
                    <select id="ecole_id" name="ecole_id" class="glass-input" required>
                        <option value="">Sélectionner une école</option>
                        @foreach($ecoles as $ecole)
                            <option value="{{ $ecole->id }}" {{ old('ecole_id') == $ecole->id ? 'selected' : '' }}>
                                {{ $ecole->nom }}
                            </option>
                        @endforeach
                    </select>
                    <label for="ecole_id">École *</label>
                </div>
                @else
                @if(auth()->user()->hasEcole() && auth()->user()->ecole)
                    <div class="glass-card mt-6 p-4 text-center">
                        <i class="fas fa-school text-neon-blue text-2xl mb-2"></i>
                        <p class="text-white">École : <strong>{{ auth()->user()->ecole->nom }}</strong></p>
                    </div>
                @else
                    <div class="glass-card mt-6 p-4 text-center border-red-500">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-2"></i>
                        <p class="text-red-400">Aucune école assignée à votre compte</p>
                        <p class="text-gray-400 text-sm mt-2">Contactez un superadmin pour assigner une école</p>
                    </div>
                @endif
                @endif

                <h3 class="text-xl font-semibold text-white mt-8 mb-4">Adresse</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-floating">
                        <input type="text" 
                               id="numero_rue" 
                               name="numero_rue" 
                               class="glass-input"
                               placeholder="Numéro"
                               value="{{ old('numero_rue') }}">
                        <label for="numero_rue">Numéro</label>
                    </div>

                    <div class="form-floating md:col-span-2">
                        <input type="text" 
                               id="nom_rue" 
                               name="nom_rue" 
                               class="glass-input"
                               placeholder="Nom de rue"
                               value="{{ old('nom_rue') }}">
                        <label for="nom_rue">Nom de rue</label>
                    </div>

                    <div class="form-floating">
                        <input type="text" 
                               id="ville" 
                               name="ville" 
                               class="glass-input"
                               placeholder="Ville"
                               value="{{ old('ville') }}">
                        <label for="ville">Ville</label>
                    </div>

                    <div class="form-floating">
                        <select id="province" name="province" class="glass-input">
                            <option value="QC" {{ old('province', 'QC') == 'QC' ? 'selected' : '' }}>Québec</option>
                            <option value="ON" {{ old('province') == 'ON' ? 'selected' : '' }}>Ontario</option>
                            <option value="NB" {{ old('province') == 'NB' ? 'selected' : '' }}>Nouveau-Brunswick</option>
                        </select>
                        <label for="province">Province</label>
                    </div>

                    <div class="form-floating">
                        <input type="text" 
                               id="code_postal" 
                               name="code_postal" 
                               class="glass-input"
                               placeholder="H0H 0H0"
                               value="{{ old('code_postal') }}"
                               maxlength="7">
                        <label for="code_postal">Code postal</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Karaté -->
        <div class="wizard-step-content" data-step="3" style="display: none;">
            <div class="glass-card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center">
                    <i class="fas fa-graduation-cap mr-3 text-neon-green"></i>
                    Informations Karaté
                </h2>

                <!-- Ceinture actuelle -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-white mb-4">Ceinture actuelle</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        @foreach($ceintures as $ceinture)
                        <label class="glass-card p-4 cursor-pointer hover:border-neon-blue transition-all">
                            <input type="radio" 
                                   name="ceinture_id" 
                                   value="{{ $ceinture->id }}"
                                   class="hidden"
                                   {{ old('ceinture_id') == $ceinture->id ? 'checked' : '' }}>
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-2 rounded-full" 
                                     style="background-color: {{ $ceinture->couleur ?? '#fff' }}">
                                </div>
                                <p class="text-white text-sm">{{ $ceinture->nom }}</p>
                            </div>
                        </label>
                        @endforeach
                    </div>
                    
                    <div class="form-floating mt-4">
                        <input type="date" 
                               id="date_derniere_ceinture" 
                               name="date_derniere_ceinture" 
                               class="glass-input"
                               value="{{ old('date_derniere_ceinture', now()->format('Y-m-d')) }}">
                        <label for="date_derniere_ceinture">Date d'obtention</label>
                    </div>
                </div>

                <!-- Séminaires -->
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Séminaires participés</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        @foreach($seminaires as $seminaire)
                        <label class="glass-card p-4 flex items-center cursor-pointer hover:border-neon-blue transition-all">
                            <input type="checkbox" 
                                   name="seminaires[]" 
                                   value="{{ $seminaire->id }}"
                                   class="mr-4 w-5 h-5"
                                   {{ is_array(old('seminaires')) && in_array($seminaire->id, old('seminaires')) ? 'checked' : '' }}>
                            <div class="flex-1">
                                <p class="text-white font-medium">{{ $seminaire->nom }}</p>
                                <p class="text-gray-400 text-sm">
                                    <i class="fas fa-calendar mr-1"></i>
                                    {{ \Carbon\Carbon::parse($seminaire->date_debut)->format('d/m/Y') }}
                                    <i class="fas fa-map-marker-alt ml-3 mr-1"></i>
                                    {{ $seminaire->lieu }}
                                </p>
                            </div>
                        </label>
                        @endforeach
                    </div>
                </div>

                <!-- Approbation -->
                <div class="mt-8">
                    <label class="glass-card p-4 flex items-center cursor-pointer hover:border-neon-green transition-all">
                        <input type="checkbox" 
                               name="approuve" 
                               value="1"
                               class="mr-4 w-5 h-5"
                               {{ old('approuve') ? 'checked' : '' }}>
                        <div>
                            <p class="text-white font-medium">Approuver directement</p>
                            <p class="text-gray-400 text-sm">Le membre sera immédiatement actif</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="wizard-step-content" data-step="4" style="display: none;">
            <div class="glass-card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-8 flex items-center">
                    <i class="fas fa-check-circle mr-3 text-neon-green"></i>
                    Confirmation
                </h2>

                <div id="summaryContent" class="space-y-6">
                    <!-- Le contenu sera généré dynamiquement -->
                </div>

                <div class="mt-8 p-4 glass-card bg-green-500 bg-opacity-10 border-green-500">
                    <p class="text-white text-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Vérifiez les informations avant de créer le membre
                    </p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8 max-w-4xl mx-auto">
            <button type="button" 
                    id="prevBtn" 
                    class="btn-glass"
                    onclick="changeStep(-1)"
                    style="display: none;">
                <i class="fas fa-arrow-left mr-2"></i>
                Précédent
            </button>

            <button type="button" 
                    id="nextBtn" 
                    class="btn-glass btn-glass-primary ml-auto"
                    onclick="changeStep(1)">
                Suivant
                <i class="fas fa-arrow-right ml-2"></i>
            </button>

            <button type="submit" 
                    id="submitBtn" 
                    class="btn-glass btn-glass-primary ml-auto"
                    style="display: none;">
                <i class="fas fa-save mr-2"></i>
                Créer le membre
            </button>
        </div>
    </form>
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>

@push('scripts')
<script>
let currentStep = 1;
const totalSteps = 4;

// Données du formulaire pour le résumé
let formData = {};

// Auto-save
setInterval(() => {
    saveFormData();
}, 5000);

function saveFormData() {
    const form = document.getElementById('wizardForm');
    const data = new FormData(form);
    const obj = {};
    
    for (let [key, value] of data.entries()) {
        if (obj[key]) {
            if (Array.isArray(obj[key])) {
                obj[key].push(value);
            } else {
                obj[key] = [obj[key], value];
            }
        } else {
            obj[key] = value;
        }
    }
    
    localStorage.setItem('memberFormData', JSON.stringify(obj));
    showToast('Sauvegarde automatique', 'success');
}

function loadFormData() {
    const saved = localStorage.getItem('memberFormData');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(key => {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                if (field.type === 'checkbox' || field.type === 'radio') {
                    field.checked = field.value === data[key];
                } else {
                    field.value = data[key];
                }
            }
        });
    }
}

function changeStep(direction) {
    // Validation avant de passer à l'étape suivante
    if (direction > 0 && !validateStep(currentStep)) {
        return;
    }

    // Masquer l'étape actuelle
    document.querySelector(`.wizard-step-content[data-step="${currentStep}"]`).style.display = 'none';
    document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');

    // Mettre à jour l'étape
    currentStep += direction;

    // Afficher la nouvelle étape
    document.querySelector(`.wizard-step-content[data-step="${currentStep}"]`).style.display = 'block';
    document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');

    // Marquer les étapes complétées
    for (let i = 1; i < currentStep; i++) {
        document.querySelector(`.wizard-step[data-step="${i}"]`).classList.add('completed');
    }

    // Gérer les boutons
    document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';
    document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

    // Si on arrive à la confirmation, générer le résumé
    if (currentStep === totalSteps) {
        generateSummary();
    }

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(step) {
    let isValid = true;
    const stepContent = document.querySelector(`.wizard-step-content[data-step="${step}"]`);
    const requiredFields = stepContent.querySelectorAll('[required]');

    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });

    if (!isValid) {
        showToast('Veuillez remplir tous les champs obligatoires', 'error');
    }

    return isValid;
}

function generateSummary() {
    const form = document.getElementById('wizardForm');
    const data = new FormData(form);
    
    let summaryHTML = '';

    // Informations personnelles
    summaryHTML += `
        <div class="glass-card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-user mr-2"></i>Informations personnelles
            </h3>
            <div class="grid grid-cols-2 gap-4 text-gray-300">
                <div>
                    <span class="text-gray-400">Nom complet:</span><br>
                    <span class="text-white">${data.get('prenom') || ''} ${data.get('nom') || ''}</span>
                </div>
                <div>
                    <span class="text-gray-400">Date de naissance:</span><br>
                    <span class="text-white">${formatDate(data.get('date_naissance')) || 'Non renseigné'}</span>
                </div>
            </div>
        </div>
    `;

    // Contact
    summaryHTML += `
        <div class="glass-card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-phone mr-2"></i>Contact
            </h3>
            <div class="grid grid-cols-2 gap-4 text-gray-300">
                <div>
                    <span class="text-gray-400">Email:</span><br>
                    <span class="text-white">${data.get('email') || 'Non renseigné'}</span>
                </div>
                <div>
                    <span class="text-gray-400">Téléphone:</span><br>
                    <span class="text-white">${data.get('telephone') || 'Non renseigné'}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('summaryContent').innerHTML = summaryHTML;
}

function previewAvatar(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
            document.getElementById('avatarPreview').style.display = 'block';
            document.getElementById('cameraIcon').style.display = 'none';
        }
        reader.readAsDataURL(file);
    }
}

function calculateAge() {
    const birthDate = new Date(document.getElementById('date_naissance').value);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    
    if (birthDate) {
        document.getElementById('ageDisplay').style.display = 'block';
        document.getElementById('ageText').textContent = `${age} ans`;
    }
}

function formatDate(dateString) {
    if (!dateString) return null;
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-glass ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
        ${message}
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Format automatique des champs
document.getElementById('telephone')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 6) {
        value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
    }
    e.target.value = value;
});

document.getElementById('code_postal')?.addEventListener('input', function(e) {
    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (value.length >= 3) {
        value = `${value.slice(0,3)} ${value.slice(3,6)}`;
    }
    e.target.value = value;
});

// Charger les données sauvegardées au chargement
document.addEventListener('DOMContentLoaded', function() {
    loadFormData();
});
</script>
@endpush
@endsection
